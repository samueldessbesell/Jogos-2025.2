#include <stdio.h>
#include <stdlib.h>
#include <conio.h>
#include <locale.h>
#include <windows.h>

#define RESET "\033[0m"
#define BLACK "\033[1;30m"
#define RED "\033[1;31m"
#define GREEN "\033[1;32m"
#define YELLOW "\033[1;33m"
#define BLUE "\033[1;34m"
#define MAGENT "\033[1;35m"
#define CYAN "\033[36m"
#define BOLD "\033[1;37m"

void habilitarCaracteresBR(){
	setlocale(LC_ALL, "");
}

void tocarSom(char tipo){
    switch(tipo){
        case 'I': Beep(750, 500); break; // Som de início de tela
        case '@': Beep(1000, 250); break; // Interação
        case 'V': Beep(1200, 250); break; // Vitória
        case 'X': Beep(300, 300); break; // Derrota
        case 'M': Beep(460, 250); break; // Movimento
        case 'E': Beep(400, 250); break; //Erro ou bloqueio
    }
}

void limparTela(){
	system("cls");
}

void iniciar(){
	printf("\n\n\n\tPressione qualquer tecla para começar...");
	getch(); limparTela();
}

void titulo(){
	limparTela();
	tocarSom('I');
	printf(YELLOW"\n"
				"\t            /\\    _.        _   |   _              \n"
				"\t           /--\\  (_|  |_|  (/_  |  (/_             \n"
				"\t                   |                               \n"
				"\t                                                   \n"
				"\t |\\/|   _   ._   _|_  o  ._   _    _   _   |  |  | \n"
				"\t |  |  (/_  | |   |_  |  |   (_)  _>  (_)  o  o  o \n\n"RESET);
}

void opcaoCreditos(){
	limparTela();
	printf(RED"\n\t\t\tThe Devs\n\n"RESET
		"\tSamuel Alessandro Dessbesell --- 23270020\n"
		"\t   Leonardo Avelar Salheb --- 23270313\n"
		"\t     João Pedro Venuto --- 25300017\n");
	printf(RED"\n\t\t\tCréditos\n\n"RESET
			BOLD"\t   Samuel D.\n\n"RESET
			"\t\tDiálogo de Personagens\n"
			"\t\tEfeitos Sonoros e Visuais\n"
			"\t\tFase 1\n"
			"\t\tGuia de Caracteres e Teclas\n"
			"\t\tInteração com Chave e NPCs\n"
			"\t\tMovimentação\n"
			"\t\tTítulo e Menu\n"
			"\t\tVida de Personagem\n"
			"\t\tVila dos Guri\n\n"
			BOLD"\t   Leonardo S.\n\n"RESET
			"\t\tBoss 1\n"
			"\t\tBotão\n"
			"\t\tDiálogo de Personagens\n"
			"\t\tEscorregar no Limo\n"
			"\t\tEspinho\n"
			"\t\tFase 2\n"
			"\t\tLava\n\n"
			BOLD"\t   João V.\n\n"RESET
			"\t\tBoss 2\n"
			"\t\tFase 3\n"
			"\t\tTeletransporte\n");
}

void opcaoSair(){
	limparTela();
	printf(YELLOW"\n\n\t\tObrigado por jogar!\n\n"RESET);
}

void desenharFase1(int xPlayer, int yPlayer, char mapa[11][11], int vida) {
    int i, j;
    limparTela();

    printf(GREEN "\n\n\t    ---{Fase 1: Sala dos Enigma}---\n\n" RESET);

    for(i = 0; i < 11; i++){ //VIDA
        if(i == 0){ 
            printf(RED"       Vidas"RESET);
        }else if(i <= vida){
            printf("\t{"RED"V"RESET"}");
        }else{
            printf("\t");
        }
        printf("\t");

        for(j = 0; j < 11; j++){ //MAPA
            if(i == yPlayer && j == xPlayer){
                printf(BLUE" &"RESET);
            }else{
                char c = mapa[i][j];
                switch(c){
                    case '*': printf(BLACK " *" RESET); break;
                    case 'X': printf(YELLOW " X" RESET); break;
                    case '@': printf(CYAN " @" RESET); break;
                    case 'D': printf(BLACK " D" RESET); break;
                    case '=': printf(" ="); break;
                    case 'H': printf(" H"); break;
                    case ' ': printf("  "); break;
                    default: printf(" %c", c); break;
                }
            }
        }

        printf("\t");
        switch(i){ //GUIA DE CARACTERES E TECLAS
			case 0: printf(BOLD"      Guia para os Caracteres"RESET); break;
			case 1: printf(BLUE"&"RESET" (personagem)"); break;
			case 2: printf(CYAN"@"RESET" (chave)"); break;
			case 3: printf("=/"BLACK"D"RESET" (porta aberta/fechada)"); break;
			case 4: printf("H (escadas para cima/baixo)"); break;
			case 5: printf(YELLOW"X"RESET" (puzzle)"); break;
			case 7: printf(BOLD"\tGuia para as Teclas"RESET); break;
			case 8: printf("w/s (mover para cima/baixo)"); break;
			case 9: printf("a/d (mover para esquerda/direita)"); break;
			case 10: printf("e (interagir com item/NPC)"); break;
		}
		printf("\n");
	}
	printf("\t\t\t\t\tQ (voltar para menu)\n");
}

void fase1(){
	int xPlayer = 1, yPlayer = 1;
    int vida = 3;
    int puzzleResolvido1 = 0;
    int puzzleResolvido2 = 0;
    int puzzleResolvido3 = 0;
    int chaveColetada1 = 0;
    int chaveColetada2 = 0;
    int chaveColetada3 = 0;

	char mapa[11][11] = {
    "***********",
    "* *  *X  **",  
    "* * ****  *",
    "*     *** *",
    "***** *   *",
    "**      ***",
    "** **D***X*", 
    "*  **     *",
    "* *******D*",
    "*  X*H D  *", 
    "***********"};

    tocarSom('I');
    desenharFase1(xPlayer, yPlayer, mapa, vida);

    while(1){
        char input = getch();
        if(input == 'Q') break;
        
        int newX = xPlayer, newY = yPlayer;
        if(input == 'w' && yPlayer > 0) newY--;
        else if(input == 's' && yPlayer < 10) newY++;
        else if(input == 'a' && xPlayer > 0) newX--;
        else if(input == 'd' && xPlayer < 10) newX++;
        else if(input == 'e'){
            //Interação com puzzle 1
            if(!puzzleResolvido1 && abs(xPlayer - 6) + abs(yPlayer - 1) == 1 && mapa[1][6] == 'X'){
                tocarSom('@');
                limparTela();
                printf(YELLOW"\n\tUm enigma surge gravado em pedra:\n\n"RESET);
                printf("\t\"Somar 2 + 2 resulta em quê?\"\n");
                
                int respostaPuzzle1;
                printf(BLUE"\n\tResposta"RESET": ");
                scanf("%d", &respostaPuzzle1);
                
                if(respostaPuzzle1 == 4){
                    tocarSom('V');
                    printf(GREEN"\n\tCorreto! O enigma se desfaz, revelando uma chave no lugar.\n"RESET);
                    getch();
                    puzzleResolvido1 = 1;
                    mapa[1][6] = '@';
                }else{
                    tocarSom('X');
                    printf(RED"\n\tResposta incorreta. O enigma permanece intacto.\n"RESET);
                    getch();
                }
                desenharFase1(xPlayer, yPlayer, mapa, vida);
            
            //Coletar a chave 1
			}else if(puzzleResolvido1 && !chaveColetada1 && abs(xPlayer - 6) + abs(yPlayer - 1) == 1 && mapa[1][6] == '@'){
                tocarSom('@');
                printf(CYAN"\n\tVocê pegou a chave misteriosa.\n"RESET);
                getch();
                chaveColetada1 = 1;
                mapa[1][6] = ' ';
                mapa[6][5] = '=';
                desenharFase1(xPlayer, yPlayer, mapa, vida);
            }else if(!chaveColetada1 && abs(xPlayer - 5) + abs(yPlayer - 6) == 1 && mapa[6][5] == 'D'){
                tocarSom('E');
            }
            
            //Interação com puzzle 2
            if(!puzzleResolvido2 && abs(xPlayer - 9) + abs(yPlayer - 6) == 1 && mapa[6][9] == 'X'){
                tocarSom('@');
                limparTela();
                printf(YELLOW"\n\tUm enigma surge gravado em pedra:\n\n"RESET);
                printf("\t\"Somar 2 + 2 resulta em quê?\"\n");
                
                int respostaPuzzle2;
                printf(BLUE"\n\tResposta"RESET": ");
                scanf("%d", &respostaPuzzle2);
                
                if(respostaPuzzle2 == 4){
                    tocarSom('V');
                    printf(GREEN"\n\tCorreto! O enigma se desfaz, revelando uma chave no lugar.\n"RESET);
                    getch();
                    puzzleResolvido2 = 1;
                    mapa[6][9] = '@';
                }else{
                    tocarSom('X');
                    printf(RED"\n\tResposta incorreta. O enigma permanece intacto.\n"RESET);
                    getch();
                }
                desenharFase1(xPlayer, yPlayer, mapa, vida);
            
            //Coletar a chave 2
			}else if(puzzleResolvido2 && !chaveColetada2 && abs(xPlayer - 9) + abs(yPlayer - 6) == 1 && mapa[6][9] == '@'){
                tocarSom('@');
                printf(CYAN"\n\tVocê pegou a chave misteriosa.\n"RESET);
                getch();
                chaveColetada2 = 1;
                mapa[6][9] = ' ';
                mapa[8][9] = '=';
                desenharFase1(xPlayer, yPlayer, mapa, vida);
            }else if(!chaveColetada2 && abs(xPlayer - 9) + abs(yPlayer - 8) == 1 && mapa[8][9] == 'D'){
                tocarSom('E');
            }
            
            //Interação com puzzle 3
            if(!puzzleResolvido3 && abs(xPlayer - 3) + abs(yPlayer - 9) == 1 && mapa[9][3] == 'X'){
                tocarSom('@');
                limparTela();
                printf(YELLOW"\n\tUm enigma surge gravado em pedra:\n\n"RESET);
                printf("\t\"Ennyn Durin aran. Pedo mellon a minno.\"\n");
                
                char respostaPuzzle3[20];
                printf(BLUE"\n\tResposta"RESET": ");
                scanf("%s", respostaPuzzle3);
                
                if(strcmp(respostaPuzzle3, "mellon") == 0){
                    tocarSom('V');
                    printf(GREEN"\n\tMae carnen! O enigma se desfaz, revelando uma chave no lugar.\n"RESET);
                    getch();
                    puzzleResolvido3 = 1;
                    mapa[9][3] = '@';
                }else{
                    tocarSom('X');
                    printf(RED"\n\tResposta incorreta. O enigma permanece intacto.\n"RESET);
                    getch();
                }
                desenharFase1(xPlayer, yPlayer, mapa, vida);
            
            //Coletar a chave 3
			}else if(puzzleResolvido3 && !chaveColetada3 && abs(xPlayer - 3) + abs(yPlayer - 9) == 1 && mapa[9][3] == '@'){
                tocarSom('@');
                printf(CYAN"\n\tVocê pegou a chave misteriosa.\n"RESET);
                getch();
                chaveColetada3 = 1;
                mapa[9][3] = ' ';
                mapa[9][7] = '=';
                desenharFase1(xPlayer, yPlayer, mapa, vida);
            }else if(!chaveColetada3 && abs(xPlayer - 5) + abs(yPlayer - 6) == 1 && mapa[6][5] == 'D'){
                tocarSom('E');
            }
            
            //Para a fase 2
        	if(mapa[yPlayer][xPlayer] == 'H'){
            tocarSom('V');
            limparTela();
            printf(GREEN"\n\tA escada se ilumina e você avança para a Fase 2.\n\n"RESET);
            getch(); break;
        	}
        }

        if(input == 'w' || input == 'a' || input == 's' || input == 'd'){
            char destino = mapa[newY][newX];
            if(destino == ' ' || destino == '=' || destino == 'H'){
                xPlayer = newX;
                yPlayer = newY;
                tocarSom('M');
            }else tocarSom('E');
            
            desenharFase1(xPlayer, yPlayer, mapa, vida);
        }
    }
}

void desenharVila(int xPlayer, int yPlayer, int vida, char vila[11][11]){
	int i, j;
	limparTela();

	printf(GREEN"\n\n\t\t----{Vila dos Guri}----\n\n"RESET);
	
	for (i = 0; i < 11; i++){
		if(i == 0){
			printf(RED"       Vidas"RESET);
		}else if(i <= vida){ //VIDA
			printf("\t{"RED"V"RESET"}");
		}else printf("\t");

		printf("\t");
		
		for(j = 0; j < 11; j++){ //MAPA
			if(i == yPlayer && xPlayer == j){
				printf(BLUE" &"RESET);
			}else{
				char c = vila[i][j];
				switch(c){
					case '*': printf(BLACK" *"RESET); break;
					case 'P':
						if(i == 1 && j == 5){ //NPC do fim do beco
							if(xPlayer == 5 && yPlayer >= 2 && yPlayer <= 3){
								printf(BLACK" P"RESET);
							}else printf("  ");
						}else printf(YELLOW" P"RESET); break;
					case 'D': printf(BLACK" D"RESET); break;
					case '=': printf(" ="); break;
					case 'H': printf(" H"); break;
					case '$': printf(" $"); break;
					case '@': printf(CYAN" @"RESET); break;
					case ' ': printf("  "); break;
					default: printf(" %c", c); break;
				}
			}
		}
		
		printf("\t");
		
		switch(i){ //GUIA DE CARACTERES E TECLAS
			case 0: printf(BOLD"      Guia para os Caracteres"RESET); break;
			case 1: printf(BLUE"&"RESET" (personagem)"); break;
			case 2: printf(CYAN"@"RESET" (chave)"); break;
			case 3: printf("=/"BLACK"D"RESET" (porta aberta/fechada)"); break;
			case 4: printf("H (escadas para cima/baixo)"); break;
			case 5: printf("$ (placa)"); break;
			case 6: printf(YELLOW"P"RESET" (NPC)"); break;
			case 7: printf(BOLD"\tGuia para as Teclas"RESET); break;
			case 8: printf("w/s (mover para cima/baixo)"); break;
			case 9: printf("a/d (mover para esquerda/direita)"); break;
			case 10: printf("e (interagir com item/NPC)"); break;
			default: printf("\n"); break;
		}
		printf("\n");
	}
	printf("\t\t\t\t\tQ (voltar para menu)\n");
}

char vila[11][11] = {
		"***********",
        "*   *P*@  *",
        "*H  * *   *",
        "*   * *   *",
        "**D** **D**",
        "*         *",
        "*P        *",
        "*         *",
        "*****D*****",
        "*$     = H*",
        "***********"};
	
char andarSuperior[11][11] = {
		"*****      ",
		"*   *      ",
		"*H  *      ",
		"*   *      ",
		"*****      ",
		"           ",
        "           ",
        "           ",
        "           ",
		"           ",
        "           ",
        "           "};
		
void opcaoJogarVila(){
	int xPlayer = 9, yPlayer = 1;
	int chaveX = 7, chaveY = 1;
	int portaX = 8, portaY = 4;
	int escadaVelhoX = 1, escadaVelhoY = 2;
	int vida = 3;
	int chaveColetada = 0;
	int interagiuComVelho = 0;
	int interagiuComMentiroso = 0;
	int andarSuperiorAtual = 0;
	char resposta[40];
	int oculosPegos = 0; 
	int oculosEntregues = 0;
	int oculosX = 3, oculosY = 3; //coordenadas no andar superior
	int portaInferiorX = 5, portaInferiorY = 8; 
	int placaX = 1, placaY = 9;
	
	tocarSom('I');
	if(andarSuperiorAtual == 0) desenharVila(xPlayer, yPlayer, vida, vila);
	else desenharVila(xPlayer, yPlayer, vida, andarSuperiorAtual);

	//MOVIMENTAÇÃO
	while(1){
		int hasValidImput = 0;
		char input = getch();
		if(input == 'Q') break;
		if(input == '9') fase1();

		int newX = xPlayer;
		int newY = yPlayer;

		if(input == 'w' && yPlayer > 0) newY--;
		else if(input == 's' && yPlayer < 10) newY++;
		else if(input == 'a' && xPlayer > 0) newX--;
		else if(input == 'd' && xPlayer < 10) newX++;
		
		if(input == 'e'){
		    if(chaveColetada == 0 && ((abs(xPlayer - chaveX) + abs(yPlayer - chaveY)) == 1)){ //CHAVE DA CASA
		        tocarSom('@');
		        chaveColetada = 1;
		        vila[chaveY][chaveX] = ' '; //Remove a chave
		        vila[portaY][portaX] = '='; //Abre a porta
		        desenharVila(xPlayer, yPlayer, vida, vila);
		    }
		    
			if((xPlayer == 2 && yPlayer == 6) && interagiuComVelho == 0){ //VELHO NPC
				tocarSom('@');
				printf(YELLOW"\n\tVelho"RESET": Ah, meu jovem... Perdi meus óculos no andar de cima.\n"
							"\tPoderia encontrá-los para mim, por favor?\n"); getch(); tocarSom('M');
				printf(BLUE"\n\tResposta"RESET": "); 
				scanf("%s", &resposta); tocarSom('M');
				printf(YELLOW"\n\tVelho"RESET": Ah, muito obrigado, jovem rapaz! Meus ouvidos já não são\n"
							"\tmuito bons como antes, mas você me parece uma boa pessoa!\n"); getch(); tocarSom('M');
				printf(YELLOW"\n\tVelho"RESET": Aliás! Esqueci de avisar, mas os meus óculos são bem pequenos!\n"
							"\tTalvez não seja tão fácil achá-los, mas eles estão lá. Boa sorte!"); getch(); tocarSom('@');
				vila[4][2] = '='; //Abre a porta
				interagiuComVelho = 1;
			}
			
			if(((abs(xPlayer - escadaVelhoX) + abs(yPlayer - escadaVelhoY)) == 1)){ //ESCADA DO VELHO
				tocarSom('@');
				if (andarSuperiorAtual == 0){
					andarSuperiorAtual = 1;
				   	desenharVila(xPlayer, yPlayer, vida, andarSuperior);
				}else{
					desenharVila(xPlayer, yPlayer, vida, vila);
					andarSuperiorAtual = 0;
				}
			}
			
			//ÓCULOS DO VELHO
			if(andarSuperiorAtual == 1 && oculosPegos == 0 && xPlayer == oculosX && yPlayer == oculosY){
			    tocarSom('@');
			    printf(BOLD"\n\tVocê encontrou um par de óculos antigos. Deve ser do velho lá embaixo.\n"RESET);
			    getch();
			    oculosPegos = 1;
			    andarSuperior[oculosY][oculosX] = ' ';
			    desenharVila(xPlayer, yPlayer, vida, andarSuperior);
			}
			
			//ENTREGAR ÓCULOS DO VELHO
			if((xPlayer == 2 && yPlayer == 6) && interagiuComVelho == 1 && oculosPegos == 1 && oculosEntregues == 0){
			    tocarSom('@');
			    printf(YELLOW"\n\tVelho"RESET": Oh glória! Você encontrou meus óculos! Agora consigo ver claramente!\n");
			    getch();
			    printf(YELLOW"\n\tVelho"RESET": Finalmente poderei abrir o portão ao sul da vila para arejar o local.\n"); getch();
				printf(YELLOW"\n\tVelho"RESET": Sugiro você não entrar lá. Você se parece muito com o meu filho.\n"
											"\tEle era muito gentil graças a Deus.\n"); getch();
				printf(YELLOW"\n\tVelho"RESET": Uma pena que ele tenha se perdido na Dungeon...\n"); getch();
				printf(YELLOW"\n\tVelho"RESET": Enfim, muito obrigado por sua generosidade. "
											"Vá com Deus, jovem rapaz!\n"); getch();
			    vila[portaInferiorY][portaInferiorX] = '='; //Abre a porta sul
			    oculosEntregues = 1;
			    desenharVila(xPlayer, yPlayer, vida, vila);
			}
			
            if (xPlayer == placaX+1 && yPlayer == placaY){ //Placa
                tocarSom('@');
                printf(RED"\n\tAtenção! Perigo à frente: Cavernas instáveis e armadilhas mortais.\n"RESET);
                getch();
                desenharVila(xPlayer, yPlayer, vida, vila);
            }

			if((xPlayer == 5 && yPlayer == 2) && interagiuComMentiroso == 0){ //MENTIR0S0 NPC
				tocarSom('@');
				printf(BLACK"\n\t???"RESET": Ei, você! Como me encontrou aqui? "
						"Ah, não importa mesmo.\n\n"); getch(); tocarSom('M');
				printf(BLACK"\t???"RESET": Já que estás aqui, gostaria de conseguir "
						"grandes riquezas?\n\n"); getch(); tocarSom('M');
				printf(BLACK"\t???"RESET": Eu deixei minhas milhares de moedas de "
						"ouro e relíquias na Dungeon.\n\n"); getch(); tocarSom('M');
				printf(BLACK"\t???"RESET": Traga o máximo que você conseguir para "
						"mim, que eu lhe darei metade.\n\n");getch(); tocarSom('M');
				printf(BLUE"\n\tResposta"RESET": "); 
				scanf("%s", &resposta); tocarSom('M');
				printf(BLACK"\n\n\t???"RESET": Faça como quiser. Mantenho a minha "
						"proposta, hihihi!\n"); getch(); tocarSom('@');
				interagiuComMentiroso = 1;
			}else tocarSom('E');
			
			if (yPlayer == 9 && xPlayer == 8 && oculosEntregues == 1){
                tocarSom('@');
                printf(GREEN"\n\tVocê desce pela escada ao sul e adentra a entrada da Dungeon.\n"RESET);
                getch(); fase1(); //Chama a fase 1
                desenharVila(xPlayer, yPlayer, vida, vila);
			}
		}
		
		if(vila[newY][newX] == ' ' || vila[newY][newX] == '='){
			xPlayer = newX;
			yPlayer = newY;
			tocarSom('M');
			hasValidImput = 1;
		}else tocarSom('E');
		
		if(hasValidImput == 1)
			if(andarSuperiorAtual == 0) desenharVila(xPlayer, yPlayer, vida, vila);
			else desenharVila(xPlayer, yPlayer, vida, andarSuperior);
	}	
}		

void menu(){
	do{
		titulo();
		printf("\t\tBem-vindo ao Aquele Mentiroso!!!\n\n"
			   "\t\tPermita-se morder a isca do mentiroso\n"
			   "\t\te Divirta-se muito com isso!!! ;D\n\n\n");
		printf("\t\tEscolha uma das opções abaixo para começar:\n\n"
			   "\t\t1 - Jogar\n"
			   "\t\t2 - Créditos\n"
			   "\t\t3 - Sair\n");

		char tecla = getch();
		switch(tecla){
			case '1': opcaoJogarVila(); tocarSom('I'); break;
			case '2': opcaoCreditos(); tocarSom('I'); break;
			case '3': opcaoSair(); tocarSom('I'); return;
			default: printf("\n\n\tOpção inválida. Tente novamente.\n");
				tocarSom('E'); break;
		}
		printf("\n\n\tPressione qualquer tecla para continuar...");
		getch();
	} while(1);
}

int main(){
	habilitarCaracteresBR();
	iniciar();
	menu();
	
	return 0;
}
